<!DOCTYPE html>
<html lang="en">
<head>
<title>Singapore Population Analysis</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

<style>
.sansserif {
	font-family: Verdana, sans-serif;
}

.pagination {
  display: inline-block;
}

.pagination a {
  color: black;
  float: left;
  padding: 8px 16px;
  text-decoration: none;
}

.pagination a.active {
  background-color: #4CAF50;
  color: white;
  border-radius: 5px;
}

.pagination a:hover:not(.active) {
  background-color: #ddd;
  border-radius: 5px;
}

.rectangle {
	fill: steelblue;
}
.rectangle:hover {
	fill: orange;
}
.axis {
  font: 10px Verdana;
}

.axis path,
.axis line {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
  
}

.footer {
	background-color: white;
	font-size: 12px;
}

.line {
    fill: none;
    stroke: #ffab00;
    stroke-width: 3;
}
  
.overlay {
  fill: none;
  pointer-events: all;
}

.dot {
    fill: #ffab00;
    stroke: #fff;
}
  
.focus circle {
  fill: none;
  stroke: steelblue;
}
</style>
  
</head>
<body>
<div class = "row sansserif">
<center><h2 class="sansserif">Singapore Population Analysis</h2></center>
 </div>
 <div class="container sansserif">
	<div class="pagination">
	  <a href="#">&laquo;</a>
	  <a href="index.html">Home</a>
	  <a href="sex_ratio.html">Male vs Female Ratio</a>
	  <a href="ethnic_growth.html">Ethnicity Growth</a>
	  <a href="age_group.html"class="active">Ethnicity vs Age Group</a>
	  <a href="#">&raquo;</a>
	</div>
<div class = "row"></div>
<br/>
<div class ="rows">
	<div class = "col-sm-3 sansserif" style="background-color:#eee;">
	<br>
	<b><u>How the age group composition looks?</u></b><br></br>
	Select different years between 1957 till 2015 to see how the different age group composition among different ethnic group in Singapore looks like. Toggle button can show which are the largest age groups for visual ease.<br>
	<br></br>	
	<br></br>
	<br></br>
	<br></br>
	<br></br>
	<br></br>
	<br></br>
	</div>
	<div class = "col-sm-9 sansserif" style="background-color:white;" id="age">
	<center><u><b> Age Group Analysis at Ethnicity Level </b></u></center>
	Select year: 
	<select id="year"></select>

	<input type="checkbox" id="sort">	
	Toggle sort 

	<br></br>
	</div>
</div>
<div class = "row sansserif">
</div>
<br></br>
<br>
<hr>
<div class="footer">
	<p class="sansserif">By. Harini MohanaSundaram for Data Visualization Exercise</p>
</div>
</div>
<script src="https://d3js.org/d3.v5.min.js"></script>
<script>
d3.csv("singapore-age-ethnicity_pivot.csv").then(d => chart(d))

function chart(csv) {
	var keys = csv.columns.slice(2);
	var year   = [...new Set(csv.map(d => d.year))]
	var level_1 = [...new Set(csv.map(d => d.level_1))]

	var options = d3.select("#year")
					.selectAll("option")
					.data(year)
					.enter()
					.append("option")
					.text(d => d)

// set the dimensions and margins of the graph
var margin = {top: 10, right: 30, bottom: 30, left: 40},
    width = 2000 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

// append the svg object to the body of the page
	var svg = d3.select("#age")
				.append("svg")
					.attr("width", width + margin.left + margin.right)
					.attr("height", height + margin.top + margin.bottom)
				.append("g")
					.attr("transform",
						  "translate(" + margin.left + "," + margin.top + ")");

	var x = d3.scaleBand()
		.range([margin.left, width - margin.right])
		.padding(0.3)

	var y = d3.scaleLinear()
		.rangeRound([height - margin.bottom, margin.top])

	var xAxis = svg.append("g")
		.attr("transform", `translate(0,${height - margin.bottom})`)
		.attr("class", "x-axis")

	var yAxis = svg.append("g")
		.attr("transform", `translate(${margin.left},0)`)
		.attr("class", "y-axis")

	var z = d3.scaleOrdinal()
		.range(['#0E6655','#808B96','#F0B27A','#283747'])
		.domain(keys);

	update(d3.select("#year").property("value"), 0)

	function update(input, speed) {

		var data = csv.filter(f => f.year == input)
		console.log(data)

		data.forEach(function(d) {
			d.total = d3.sum(keys, k => +d[k])
			return d
		})
		
		console.log(data)

		y.domain([0, d3.max(data, d => d3.sum(keys, k => +d[k]))]).nice();

		svg.selectAll(".y-axis")
			.transition()
			.duration(speed)
			.call(d3.axisLeft(y).ticks(null, "s"))

		// text label for the y axis
		svg.append("text")
			  .attr("transform", "rotate(-90)")
			  .attr("y",0 - margin.left + 15)
			  .attr("x",0 - (height / 2))
			  .attr("dy", "1em")
			  .style("text-anchor", "middle")
			  .text("Population Count");

		data.sort(d3.select("#sort").property("checked")
			? (a, b) => b.total - a.total
			: (a, b) => level_1.indexOf(a.level_1) - level_1.indexOf(b.level_1))

		x.domain(data.map(d => d.level_1));

		svg.selectAll(".x-axis").transition().duration(speed)
			.call(d3.axisBottom(x).tickSizeOuter(0))

		svg.append("text")             
				.attr("transform",
					  "translate(" + (width/2) + " ," + 
                           (height + margin.top + 10) + ")")
			.style("text-anchor", "middle")
			.text("Different Ethnicity Groups");


		var group = svg.selectAll("g.layer")
			.data(d3.stack().keys(keys)(data), d => d.key)

		group.exit().remove()

		group.enter().append("g")
			.classed("layer", true)
			.attr("fill", d => z(d.key));

		var bars = svg.selectAll("g.layer").selectAll("rect")
			.data(d => d, e => e.data.level_1);

		bars.exit().remove()

		bars.enter()
			.append("rect")
			.attr("width", x.bandwidth())
			.merge(bars)
		.transition().duration(speed)
			.attr("x", d => x(d.data.level_1))
			.attr("y", d => y(d[1]))
			.attr("height", d => y(d[0]) - y(d[1]))

		var text = svg.selectAll(".text")
						.data(data, d => d.level_1);

		text.exit().remove()

		text.enter().append("text")
			.attr("class", "text")
			.attr("text-anchor", "middle")
			.merge(text)
		.transition().duration(speed)
			.attr("x", d => x(d.level_1) + x.bandwidth() / 2)
			.attr("y", d => y(d.total) - 5)
			.text(d => d.total)
			
		var legend = text.append("g")
						.data(data)
						.attr("class", "legend")
						.attr("transform", function(d) { var d = d[d.length - 1]; return "translate(" + (x0(d.data.level_1) + x1(d.data.year) + x1.bandwidth()) + "," + ((y(d[0]) + y(d[1])) / 2) + ")"; });

		legend.append("line")
				.attr("x1", -6)
				.attr("x2", 6)
				.attr("stroke", "#000");

		legend.append("text")
				.attr("x", 9)
				.attr("dy", "0.35em")
				.attr("fill", "#000")
				.style("font", "10px sans-serif")
				.text(function(d) { return d.key; });
		
		
	}

	var select = d3.select("#year")
		.on("change", function() {
			update(this.value, 750)
		})

	var checkbox = d3.select("#sort")
		.on("click", function() {
			update(select.property("value"), 750)
		})
		

}
</script>
</body>
</html>
